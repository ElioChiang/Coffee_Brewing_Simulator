import streamlit as st


st.title("â˜• å’–å•¡æ²–ç…®åƒæ•¸æ¨¡æ“¬å™¨")
st.markdown("æ¨¡æ“¬ä¸åŒåƒæ•¸èˆ‡è™•ç†æ³•ä¸‹ï¼Œå¯èƒ½ç”¢ç”Ÿçš„é¢¨å‘³èˆ‡å»ºè­°èª¿æ•´æ–¹å‘")

# æ¨¡å¼åˆ‡æ›
mode = st.sidebar.radio("è«‹é¸æ“‡æ¨¡å¼", ["æ™®é€šæ¨¡å¼", "å°ˆæ¥­æ¨¡å¼ | æ‚¶è’¸ã€æ–·æ°´"])

st.sidebar.header("è«‹è¼¸å…¥æ²–ç…®åƒæ•¸")

ratio = st.sidebar.slider("ç²‰æ°´æ¯”ï¼ˆ1:Xï¼‰", 10.0, 20.0, 15.0, 0.5)
time = st.sidebar.slider("ç¸½æ²–ç…®æ™‚é–“ï¼ˆç§’ï¼‰", 60, 240, 150, 10)
temperature = st.sidebar.slider("æ°´æº«ï¼ˆÂ°Cï¼‰", 80, 100, 90, 1)
grind_size = st.sidebar.radio("ç ”ç£¨åº¦", ["ç²—ç ”ç£¨", "ä¸­ç­‰ç ”ç£¨", "ç´°ç ”ç£¨"], index=1)
process_method = st.sidebar.selectbox("è™•ç†æ³•", ["æ°´æ´—", "æ—¥æ›¬", "èœœè™•ç†"])

# å°ˆæ¥­æ¨¡å¼ç¨æœ‰åƒæ•¸
blooming_time = 0
pour_count = 0
if mode == "å°ˆæ¥­æ¨¡å¼ | æ‚¶è’¸ã€æ–·æ°´":
    blooming_time = st.sidebar.slider("æ‚¶è’¸æ™‚é–“ï¼ˆç§’ï¼‰", 0, 60, 30, 5)
    pour_count = st.sidebar.slider("æ–·æ°´æ¬¡æ•¸", 0, 5, 2, 1)


def calculate_flavor_profile(ratio, time, temperature, grind_size, process_method, blooming_time=0, pour_count=0):
    acid, sweet, bitter, body = 3, 3, 2, 2

    # åŸºæœ¬åƒæ•¸å½±éŸ¿
    if grind_size == "ç´°ç ”ç£¨" and time > 180: # ç´°ç ”ç£¨ + é•·æ™‚é–“ -> éåº¦èƒå–
        bitter += 2
        acid -= 1
    elif grind_size == "ç²—ç ”ç£¨" and time < 120: # ç²—ç ”ç£¨ + çŸ­æ™‚é–“ -> èƒå–ä¸è¶³
        sweet -= 1
        body -= 1
    elif grind_size == "ç²—ç ”ç£¨" and time > 180: # æ–°å¢ï¼šç²—ç ”ç£¨ + é•·æ™‚é–“ -> ç¨€è–„ã€æ¬ èƒé…¸
        sweet -= 1
        body -= 2
        acid += 1
    elif grind_size == "ç´°ç ”ç£¨" and time < 100: # æ–°å¢ï¼šç´°ç ”ç£¨ + çŸ­æ™‚é–“ -> å°–éŠ³é…¸
        acid += 2
        bitter -= 1
        sweet -= 1


    if ratio < 14: # ç²‰é‡ç›¸å°è¼ƒå¤š
        sweet += 1
        body += 1
    elif ratio > 17: # ç²‰é‡ç›¸å°è¼ƒå°‘
        acid += 1
        body -= 1

    if temperature > 94: # é«˜æ°´æº«
        bitter += 1
        acid -= 1
    elif temperature < 88: # ä½æ°´æº«
        acid += 1
        sweet -= 1

    # è™•ç†æ³•å½±éŸ¿
    if process_method == "æ—¥æ›¬":
        sweet += 1.5 # æ—¥æ›¬ç”œæ„Ÿæ›´å¼·
        body += 1
        acid -= 0.5 # é…¸åº¦å¯èƒ½è¢«ç”œæ„Ÿæ©è“‹æˆ–è¼ƒä¸çªå‡º
    elif process_method == "æ°´æ´—":
        acid += 1.5 # æ°´æ´—å¼·èª¿é…¸è³ªèˆ‡ä¹¾æ·¨åº¦
        body -= 0.5 # ç›¸å°æ¸…çˆ½
    elif process_method == "èœœè™•ç†":
        sweet += 1
        acid += 0.5 # ç”œæ„Ÿæå‡ï¼ŒåŒæ™‚ä¿æœ‰ä¸€å®šé…¸è³ª


    # å°ˆæ¥­æ¨¡å¼åƒæ•¸å½±éŸ¿
    if mode == "å°ˆæ¥­æ¨¡å¼ | æ‚¶è’¸ã€æ–·æ°´":
        if blooming_time < 20: # æ‚¶è’¸æ™‚é–“ä¸è¶³
            acid += 1
            body -= 1
        elif blooming_time > 40: # æ‚¶è’¸æ™‚é–“éé•·
            bitter += 1
            sweet -= 1

        if pour_count == 0: # ç„¡æ–·æ°´
            body -= 1
            sweet -= 1
            acid += 0.5 # èƒå–ä¸å‡å¯èƒ½å°è‡´æ¬ èƒé…¸
        elif pour_count >= 3: # æ–·æ°´æ¬¡æ•¸è¼ƒå¤š
            acid += 0.5 # æå‡å±¤æ¬¡èˆ‡é…¸è³ªå‘ˆç¾
            bitter -= 0.5 # æ¸›å°‘è‹¦å‘³èƒå–ï¼Œæˆ–ä½¿è‹¦å‘³æ›´å¹³è¡¡
            sweet += 0.5 # ç”œæ„Ÿå¯èƒ½æ›´ä½³


    return (
        min(max(acid, 0), 5),
        min(max(sweet, 0), 5),
        min(max(bitter, 0), 5),
        min(max(body, 0), 5),
    )


def suggest_flavor_notes(acid, sweet, bitter, body, process_method):
    notes = []

    # 1. æ ¹æ“šè™•ç†æ³•æ±ºå®šåŸºç¤é¢¨å‘³åŸºèª¿
    if process_method == "æ°´æ´—":
        notes.append("æ­¤ç‚º**æ°´æ´—è™•ç†**çš„å’–å•¡ï¼Œæ•´é«”é¢¨å‘³é€šå¸¸**ä¹¾æ·¨ã€æ˜äº®**ã€‚")
    elif process_method == "æ—¥æ›¬":
        notes.append("æ­¤ç‚º**æ—¥æ›¬è™•ç†**çš„å’–å•¡ï¼Œæ•´é«”é¢¨å‘³é€šå¸¸**é†‡åšã€å¥”æ”¾**ï¼Œå¸¶æœ‰æ˜é¡¯çš„æœå¯¦ç”œæ„Ÿã€‚")
    elif process_method == "èœœè™•ç†":
        notes.append("æ­¤ç‚º**èœœè™•ç†**çš„å’–å•¡ï¼Œé¢¨å‘³ä»‹æ–¼æ°´æ´—èˆ‡æ—¥æ›¬ä¹‹é–“ï¼Œé€šå¸¸å…·æœ‰**ä¹¾æ·¨çš„ç”œæ„Ÿèˆ‡å¹³è¡¡çš„é…¸è³ª**ã€‚")

    # 2. æ ¹æ“šå„é¢¨å‘³ç¶­åº¦çš„å¼·åº¦ä¾†ç´°åŒ–æè¿°
    # --- é…¸åº¦ ---
    if acid >= 4:
        if process_method == "æ°´æ´—":
            notes.append("- **é«˜é…¸åº¦ï¼š** å‘ˆç¾**æ˜äº®ã€æ´»æ½‘çš„æŸ‘æ©˜ã€æª¸æª¬**é…¸æ„Ÿï¼Œæˆ–åƒ**ç¶ èŒ¶**èˆ¬æ¸…çˆ½ï¼Œç´”æ·¨ä¸”å…·ç©¿é€åŠ›ã€‚")
        elif process_method == "æ—¥æ›¬":
            notes.append("- **é«˜é…¸åº¦ï¼š** å¤šç‚º**è“æœï¼ˆè‰è“ã€è—è“ï¼‰æˆ–ç†±å¸¶æ°´æœ**èˆ¬çš„ç”œé…¸ï¼Œåœ“æ½¤ä¸”å¤šæ±ï¼Œèˆ‡ç”œæ„Ÿç›¸è¼”ç›¸æˆã€‚")
        elif process_method == "èœœè™•ç†":
            notes.append("- **é«˜é…¸åº¦ï¼š** å¸¸è¦‹æ–¼**è˜‹æœã€è‘¡è„**æˆ–**æŸ”å’ŒæŸ‘æ©˜**èˆ¬çš„é…¸è³ªï¼Œé…¸ç”œå¹³è¡¡ï¼Œä¼´éš¨å›ç”˜ã€‚")
    elif acid >= 2: # ä¸­ç­‰é…¸åº¦
        if process_method == "æ°´æ´—":
            notes.append("- **ä¸­ç­‰é…¸åº¦ï¼š** é…¸è³ªæ¸…æ™°ï¼Œå¯èƒ½å¸¶æœ‰**è¼•ç›ˆçš„æŸ‘æ©˜æˆ–å …æœèª¿**ï¼Œæ•´é«”å¹³è¡¡ã€‚")
        elif process_method == "æ—¥æ›¬":
            notes.append("- **ä¸­ç­‰é…¸åº¦ï¼š** é…¸è³ªæŸ”å’Œï¼Œèå…¥æ•´é«”æœé¦™èˆ‡ç”œæ„Ÿä¸­ï¼Œä¸çªå…€ã€‚")
        elif process_method == "èœœè™•ç†":
            notes.append("- **ä¸­ç­‰é…¸åº¦ï¼š** é…¸è³ªåœ“æ½¤ï¼Œèˆ‡ç”œæ„Ÿäº¤ç¹”ï¼Œå‘ˆç¾**ç„¦ç³–åŒ–çš„æ°´æœ**é¢¨å‘³ã€‚")
    else: # ä½é…¸åº¦æˆ–é…¸åº¦ä¸æ˜é¡¯
        notes.append("- **ä½é…¸åº¦ï¼š** é…¸è³ªä¸æ˜é¡¯æˆ–è¢«å…¶ä»–é¢¨å‘³æ©è“‹ï¼Œå£æ„Ÿå¯èƒ½è¼ƒç‚ºå¹³ç©©æˆ–åè‹¦ã€‚")

    # --- ç”œæ„Ÿ ---
    if sweet >= 4:
        if process_method == "æ°´æ´—":
            notes.append("- **é«˜ç”œæ„Ÿï¼š** å‘ˆç¾**è”—ç³–ã€ç„¦ç³–**èˆ¬çš„ä¹¾æ·¨ç”œå‘³ï¼Œæˆ–**èŠ±èœœèˆ¬**çš„ç´°è†©å›ç”˜ï¼Œé¤˜éŸ»ç¶¿é•·ã€‚")
        elif process_method == "æ—¥æ›¬":
            notes.append("- **é«˜ç”œæ„Ÿï¼š** æœ‰è‘—æ¿ƒéƒçš„**ç†±å¸¶æ°´æœä¹¾ã€è“æœé†¬ã€èœ‚èœœã€æ¥“ç³–æ¼¿**èˆ¬çš„é¦™ç”œï¼Œé†‡åšä¸”æŒä¹…ã€‚")
        elif process_method == "èœœè™•ç†":
            notes.append("- **é«˜ç”œæ„Ÿï¼š** å¸¸è¦‹æ–¼**ç†Ÿæœã€ç„¦ç³–ã€èœ‚èœœ**èˆ¬çš„ç”œæ„Ÿï¼Œé€šå¸¸å¸¶æœ‰è‰¯å¥½çš„ä¸€è‡´æ€§èˆ‡é»ç¨ åº¦ï¼Œå›ç”˜æ˜é¡¯ã€‚")
    elif sweet >= 2: # ä¸­ç­‰ç”œæ„Ÿ
        notes.append("- **ä¸­ç­‰ç”œæ„Ÿï¼š** ç”œæ„Ÿå¹³è¡¡ï¼Œèƒ½è¥¯æ‰˜å…¶ä»–é¢¨å‘³ï¼Œä½¿å£æ„Ÿæ›´åœ“æ½¤ã€‚")
    else: # ä½ç”œæ„Ÿ
        notes.append("- **ä½ç”œæ„Ÿï¼š** ç”œæ„Ÿä¸è¶³ï¼Œå’–å•¡é¢¨å‘³å¯èƒ½é¡¯å¾—å–®è–„æˆ–å¹³æ·¡ã€‚")

    # --- è‹¦å‘³ ---
    if bitter >= 4:
        if process_method == "æ°´æ´—":
            notes.append("- **é«˜è‹¦å‘³ï¼š** å¯èƒ½ä¾†è‡ªéåº¦èƒå–ï¼Œå‘ˆç¾**çƒ˜çƒ¤å …æœã€æ¿ƒéƒé»‘å·§å…‹åŠ›**çš„æ·±æ²‰è‹¦æ„Ÿï¼Œæˆ–å¸¶æœ‰**è—¥è‰ã€æœ¨è³ª**æ°£æ¯ã€‚")
        elif process_method == "æ—¥æ›¬":
            notes.append("- **é«˜è‹¦å‘³ï¼š** æœ‰æ™‚ä¼´éš¨**çƒ˜çƒ¤å‘³ã€é‡å¯å¯**çš„è¤‡é›œæ„Ÿï¼Œè‹¥è™•ç†ä¸ç•¶å¯èƒ½å‡ºç¾**åœŸå‘³æˆ–ç™¼é…µå‘³**ã€‚")
        elif process_method == "èœœè™•ç†":
            notes.append("- **é«˜è‹¦å‘³ï¼š** å¤šç‚º**å¯å¯ã€ç„¦ç³–**èˆ¬çš„é†‡åšè‹¦å‘³ï¼Œè‹¥èˆ‡ç”œæ„Ÿå¹³è¡¡å‰‡èƒ½å¢åŠ æ·±åº¦ã€‚")
    elif bitter >= 2: # ä¸­ç­‰è‹¦å‘³
        notes.append("- **ä¸­ç­‰è‹¦å‘³ï¼š** è‹¦å‘³é©ä¸­ï¼Œèƒ½å¢åŠ å’–å•¡çš„åšå¯¦æ„Ÿèˆ‡å±¤æ¬¡ï¼Œä¸é¡¯çªå…€ã€‚")
    else: # ä½è‹¦å‘³
        notes.append("- **ä½è‹¦å‘³ï¼š** è‹¦å‘³ä¸æ˜é¡¯ï¼Œæ•´é«”é¢¨å‘³å¯èƒ½æ›´åå‘é…¸ç”œæ„Ÿï¼Œå£æ„Ÿè¼ƒæ¸…çˆ½ã€‚")

    # --- åšåº¦ï¼ˆBodyï¼‰---
    if body >= 4:
        if process_method == "æ°´æ´—":
            notes.append("- **é«˜åšåº¦ï¼š** å£æ„Ÿ**æ»‘é †ã€ä¹¾æ·¨**ï¼Œåƒ**çµ²ç¶¢èˆ¬**çš„ç´°è†©è³ªæ„Ÿï¼Œé¤˜éŸ»æ¸…çˆ½è€Œç¶¿é•·ã€‚")
        elif process_method == "æ—¥æ›¬":
            notes.append("- **é«˜åšåº¦ï¼š** å£æ„Ÿ**é†‡åšã€é»ç¨ **ï¼Œåƒ**å¥¶æ²¹ã€ç³–æ¼¿èˆ¬**çš„é£½æ»¿åº¦ï¼Œå¼·å‹ä¸”æŒä¹…ï¼Œå……æ»¿å£è…”ã€‚")
        elif process_method == "èœœè™•ç†":
            notes.append("- **é«˜åšåº¦ï¼š** å£æ„Ÿ**åœ“æ½¤ã€ä¸­ç­‰ååš**ï¼Œæœ‰è‘—è‰¯å¥½çš„**é»ç¨ æ„Ÿèˆ‡è³ªæ„Ÿ**ï¼Œæä¾›è±å¯Œçš„å£è…”é«”é©—ã€‚")
    elif body >= 2: # ä¸­ç­‰åšåº¦
        notes.append("- **ä¸­ç­‰åšåº¦ï¼š** å£æ„Ÿé©ä¸­ï¼Œæ—¢ä¸å–®è–„ä¹Ÿä¸åšé‡ï¼Œå¹³è¡¡èˆ’é©ã€‚")
    else: # ä½åšåº¦
        notes.append("- **ä½åšåº¦ï¼š** å£æ„Ÿæ¸…æ·¡ï¼Œå¯èƒ½é¡¯å¾—æ°´æ„Ÿæˆ–å–®è–„ï¼Œé¤˜éŸ»è¼ƒçŸ­ã€‚")

    # 3. ç¶œåˆå¹³è¡¡æ€§æè¿° (åƒ…åœ¨æ²’æœ‰ä»»ä½•ä¸€å€‹é¢¨å‘³ç‰¹åˆ¥çªå‡ºæ™‚é¡¯ç¤º)
    if not any([acid >= 4, sweet >= 4, bitter >= 4, body >= 4]):
        if process_method == "æ°´æ´—":
            notes.append("æ•´é«”é¢¨å‘³**æ¥µç‚ºå¹³è¡¡ã€æ¸…çˆ½èˆ‡ä¹¾æ·¨**ï¼Œé…¸ç”œè‹¦åšåº¦å®Œç¾èåˆï¼Œå±•ç¾å‡ºå’–å•¡è±†ç´”ç²¹ä¸”é«˜é›…çš„é¢¨å‘³ã€‚")
        elif process_method == "æ—¥æ›¬":
            notes.append("æ•´é«”é¢¨å‘³**å’Œè«§ã€è±å¯Œ**ï¼Œå¸¶æœ‰æº«å’Œçš„æœé¦™ç”œæ„Ÿï¼Œå£æ„Ÿåœ“æ½¤ï¼Œå±¤æ¬¡æ„Ÿä½³ã€‚")
        elif process_method == "èœœè™•ç†":
            notes.append("æ•´é«”é¢¨å‘³**å®Œç¾å¹³è¡¡ã€æŸ”å’Œ**ï¼Œç”œæ„Ÿèˆ‡é…¸è³ªèåˆå¾—å®œï¼Œå£æ„Ÿæ»‘é †ï¼Œé¤˜éŸ»ç”œç¾è€ŒæŒä¹…ã€‚")

    return notes


# ç¢ºä¿ adjustment_tips å‡½æ•¸åœ¨ä½¿ç”¨å‰è¢«å®šç¾©
def adjustment_tips(ratio, temperature, blooming_time=0, pour_count=0, mode="æ™®é€šæ¨¡å¼"):
    tips = []
    if ratio < 14:
        tips.append("âœ” å»ºè­°æå‡ç²‰æ°´æ¯”è‡³ 1:15ï½1:16 ä»¥å¢åŠ ç”œæ„Ÿèˆ‡åšåº¦")
    elif ratio > 17:
        tips.append("âœ” ç²‰æ°´æ¯”åé«˜ï¼Œå»ºè­°é™ä½è‡³ 1:15ï½1:16 ä»¥é¿å…é¢¨å‘³éæ·¡æˆ–ç”¢ç”Ÿé…¸æ¾€")
    if temperature > 94:
        tips.append("âœ” æ°´æº«åé«˜ï¼Œå»ºè­°é™è‡³ 91ï½93Â°C ä»¥é¿å…éè‹¦")
    elif temperature < 88:
        tips.append("âœ” æ°´æº«åä½ï¼Œå»ºè­°æå‡è‡³ 90Â°C ä»¥ä¸Šå¼·åŒ–èƒå–")

    if mode == "å°ˆæ¥­æ¨¡å¼":
        if blooming_time < 20:
            tips.append("âœ” æ‚¶è’¸æ™‚é–“ä¸è¶³ï¼Œå»ºè­°å»¶é•·è‡³ 30-40 ç§’ï¼Œæœ‰åŠ©æ–¼å‡å‹»èƒå–ä¸¦æå‡ç”œæ„Ÿ")
        elif blooming_time > 40:
            tips.append("âœ” æ‚¶è’¸æ™‚é–“éé•·ï¼Œå¯èƒ½å°è‡´éåº¦èƒå–ç”¢ç”Ÿè‹¦å‘³ï¼Œå»ºè­°ç¸®çŸ­è‡³ 30-40 ç§’")
        if pour_count == 0:
            tips.append("âœ” å»ºè­°å˜—è©¦è‡³å°‘ 1-2 æ¬¡æ–·æ°´ï¼Œæœ‰åŠ©æ–¼åˆ†æ®µèƒå–ï¼Œæå‡é¢¨å‘³å±¤æ¬¡")
        elif pour_count >= 3:
            tips.append("âœ” æ–·æ°´æ¬¡æ•¸è¼ƒå¤šï¼Œè‹¥é¢¨å‘³éæ–¼è¤‡é›œæˆ–é…¸åº¦çªå‡ºï¼Œå¯è€ƒæ…®æ¸›å°‘æ–·æ°´æ¬¡æ•¸æˆ–èª¿æ•´æ³¨æ°´æ–¹å¼")

    if not tips:
        tips.append("âœ” åƒæ•¸é…ç½®è‰¯å¥½ï¼Œå¯å˜—è©¦å¾®èª¿ç ”ç£¨åº¦å¾®èª¿é¢¨å‘³")
    return tips


st.subheader("ğŸ“ æ¨¡æ“¬çµæœ")

acid, sweet, bitter, body = calculate_flavor_profile(
    ratio, time, temperature, grind_size, process_method, blooming_time, pour_count
)

st.markdown("**é¢¨å‘³å¼·åº¦é æ¸¬**")
for label, value in [("é…¸åº¦", acid), ("ç”œæ„Ÿ", sweet), ("è‹¦å‘³", bitter), ("åšåº¦ï¼ˆBodyï¼‰", body)]:
    st.write(label)
    st.progress(value / 5)



st.markdown("**å¯èƒ½é¢¨å‘³æ•˜è¿°**")
# å°‡ process_method å‚³å…¥ suggest_flavor_notes
notes = suggest_flavor_notes(acid, sweet, bitter, body, process_method)
for note in notes:
    st.markdown(f"{note}") # ä½¿ç”¨ f-string ç›´æ¥è¼¸å‡ºï¼Œçœå» - è™Ÿè®“æ’ç‰ˆæ›´è‡ªç„¶

st.markdown("---") # åŠ å…¥åˆ†éš”ç·šï¼Œä½¿æ’ç‰ˆæ›´æ¸…æ™°
st.markdown("**ğŸ“Œ å»ºè­°èª¿æ•´**")
for tip in adjustment_tips(ratio, temperature, blooming_time, pour_count, mode):
    st.write(f"- {tip}") # ä½¿ç”¨ f-string ä¿æŒä¸€è‡´æ€§